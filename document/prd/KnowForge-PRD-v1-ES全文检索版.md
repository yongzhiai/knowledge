# 产品需求文档（PRD）
## AI 协作个人知识沉淀系统（KnowForge）
## 修订版 v1（P0 仅全文检索，检索存储统一 Elasticsearch）

## 1. 产品概述
### 1.1 产品定位
KnowForge 是一个以 Markdown 为核心存储格式的 Web 个人知识管理（PKM）系统，面向程序员/技术学习者。系统围绕“快速捕捉 -> 项目笔记 -> 永久沉淀 -> 网络化复用”的知识闭环构建。

核心定位：
- 本地优先：单用户本地部署，数据自主管控。
- AI 协作：通过 MCP REST API 与本地 AI 工具（Claude Code CLI / Codex CLI）协作。
- 可扩展：采用快速可迭代架构，先交付可用版本，再持续演进至完整能力。

### 1.2 产品目标
- 解决“捕获易、沉淀难、复用弱”的问题，形成长期知识资产。
- 先快速交付首版可用闭环，再迭代支持 PRD 全量能力。
- 最终产出：原子化 Markdown 卡片 + 领域知识网络。

### 1.3 目标用户与场景
- 用户：后端程序员、技术学习者。
- 场景：技术文档整理、算法刷题、概念总结、子领域学习（如 Redis/Kafka）。

## 2. 范围与迭代策略
### 2.1 迭代原则
- 第一版以“可用优先、快速上线”为目标。
- 架构预留扩展点，避免后续推倒重来。

### 2.2 里程碑
#### P0（1-2 天）
实现最小可用闭环：
- Markdown 笔记 CRUD。
- 全文检索（ES）。
- CLI 重写后回写。
- 操作审计 + Git 历史。
- 最小 Web 页面（列表/编辑/搜索）。

#### P1（2-4 周）
按以下顺序补齐核心能力：
1. 原子卡片提取与关联。
2. Wiki 图谱可视化。
3. 模板系统。
4. Projects 子领域笔记组织增强。
5. 向量入库与向量检索（ES dense_vector）。

#### P2（后续）
- 混合检索（全文 + 向量融合）。
- 高级自动化工作流与知识图谱分析。

## 3. 核心工作流与典型场景
### 3.1 主工作流
1. 快速捕捉（Inbox）-> 临时 Markdown。
2. 项目笔记（Projects）-> 子领域结构化笔记。
3. 永久沉淀（Wiki）-> 原子化卡片与链接关系。
4. AI 协作：CLI 调 MCP API -> 系统执行并更新结果。

### 3.2 典型场景
- 从网页剪藏生成闪念，CLI 下发整理指令，系统回写内容。
- 在 Project 中学习 Redis，持续沉淀为可复用知识笔记。
- 全文检索“分布式锁”，定位相关笔记并跳转编辑。

## 4. 功能模块（v1 修订）
### 4.1 快速捕捉 Inbox
- 支持文本闪念创建。
- 记录标题、标签、时间。
- 落地到 Markdown + 元数据。

### 4.2 笔记编辑器
- Markdown 编辑、代码块高亮、保存。
- 支持 wiki-link 语法（[[...]]）保留。
- 支持版本追踪（Git）。

### 4.3 项目笔记 Projects
- 作为“学习子领域笔记空间”，支持目录组织。
- P0 不做重型任务管理，仅保留结构化笔记能力。

### 4.4 永久知识库 Wiki
- P0：先支持内容存取与全文检索。
- P1：补原子卡片、关系、图谱。

### 4.5 模板系统
- P1 实现（算法题、概念、日报、目标等）。

### 4.6 搜索与查询
- P0：仅全文检索（ES）。
- P1：向量检索（ES dense_vector）。
- P2：混合检索。

### 4.7 MCP 工具集（外部协作接口）
说明：首版采用 REST 资源风格接口。

## 5. API 设计（P0 实现）
### 5.1 已实现接口（P0）
- `POST /api/mcp/notes`：创建笔记。
- `GET /api/mcp/notes/{noteId}`：读取笔记。
- `PUT /api/mcp/notes/{noteId}`：更新笔记。
- `POST /api/mcp/notes/{noteId}/rewrite-apply`：应用 CLI 生成的新内容。
- `GET /api/mcp/search/fulltext`：全文检索。
- `GET /api/mcp/audit/logs`：查询审计日志。
- `GET /api/mcp/git/history/{noteId}`：查看笔记历史。
- `POST /api/mcp/git/revert/{noteId}`：回滚到指定版本。

### 5.2 预留接口（P1，不在 P0 落地）
- `POST /api/mcp/index/vectorize/{noteId}`：向量化入库。
- `GET /api/mcp/search/vector`：向量检索。
- `GET /api/mcp/search/hybrid`：混合检索。

### 5.3 关键约定
- `noteId` 使用 UUID。
- `path` 为独立字段，不作为主键。
- 错误码统一：`NOTE_NOT_FOUND`、`INVALID_MARKDOWN`、`ES_INDEX_FAILED`、`GIT_COMMIT_FAILED` 等。

## 6. 数据模型与存储方案
### 6.1 存储分工
- Markdown 文件系统：正文源数据。
- MySQL：元数据、关系、审计索引。
- Elasticsearch：检索索引（全文为主，向量预留）。

### 6.2 ES 统一检索策略
- P0：仅使用全文字段检索。
- P1：在 ES 中启用 dense_vector 并接入向量检索。
- 与现有 `es_note_index.json` 保持一致，沿用 IK + pinyin 分词方案。

### 6.3 实体（核心）
- Note：`id, type, path, title, tags, status, domain, created_at, updated_at`。
- AuditLog：`id, note_id, operator, source, before_hash, after_hash, diff, created_at`。
- Link（P1）：`from_id, to_id, relation_type`。

## 7. 技术架构与实现要点
### 7.1 技术栈约束
- 后端：JDK 21、Spring Boot 4.x、Spring AI。
- 数据：MySQL + Elasticsearch + 本地文件系统。
- 前端：Vue3 + Vite（最小页面起步）。

### 7.2 架构风格
- 模块化单体 + SPI 扩展点。
- 后端职责边界：
  - 后端负责检索、存取、审计、回滚。
  - 内容生成由外部 CLI + 大模型完成，后端只做“应用写入”。

### 7.3 关键实现
- 写入后同步更新 ES，保证“写后可搜”。
- 每次写入自动 Git 提交。
- 强制审计日志（before/after diff）。

## 8. 非功能需求
- P0 性能目标：
  - 笔记读写 < 1s。
  - 全文检索 < 1.5s（topK=20）。
- 稳定性：Git 自动提交成功率 > 99%。
- 可扩展性：后续向量与图谱能力无需推翻现有结构。

## 9. 测试与验收标准
### 9.1 测试策略（P0）
- API 契约测试。
- 核心流程集成测试（文件系统 + MySQL + ES + Git）。

### 9.2 验收场景
1. Web 新建笔记 -> 全文检索可命中。
2. CLI 回写 -> 检索结果实时更新。
3. 误改后通过 Git 回滚恢复。
4. 审计日志能完整追溯改动。

## 10. 假设与边界
- 当前默认本地单机使用。
- P0 不做语义检索。
- 向量检索最终也采用 ES 存储与检索。
- 最终目标不变：当前 PRD 所列功能将通过后续迭代全部支持。

## 11. 原型UI说明与引用
### 11.1 原型文件路径
- `document/prototype-ui/knowforge-p0-ui-calm-editorial-review.html`

说明：以上两个文件用于 P0 阶段的前端交互审查与 PRD 补充，不作为最终生产 UI 代码。

### 11.2 原型覆盖的 P0 能力点
- 顶部全局入口：品牌区、全局搜索输入、新建笔记入口。
- 一级导航：笔记列表、编辑器、全文检索。
- 笔记列表区：支持多级目录管理（目录/子目录/笔记）、展开/收起、节点选中联动右侧预览。
- 编辑器区：支持编辑、预览、全屏三态切换；支持 Esc 退出全屏；保留 Ctrl/Cmd+S 保存提示。
- 全文检索区：关键词检索结果、命中高亮、无结果态展示。
- 状态区：空状态、无结果、加载中、错误态示例。

### 11.3 基于原型补充的交互约束（纳入 P0）
- 列表区在笔记量增大时，必须提供可用的多级目录导航能力，不依赖平铺卡片列表。
- 编辑器必须提供“编辑/预览”双模式和“全屏/退出全屏”能力，以满足专注写作与审阅场景。
- 目录节点应支持键盘操作（Enter/Space），全屏应支持 Esc 退出，满足基础可访问性要求。

### 11.4 原型与后续实现边界
- 原型中的目录数据为静态 mock，仅用于交互审查。
- 实际实现阶段由后端目录/笔记元数据驱动渲染。
- 原型中的 markdown 预览为轻量渲染，生产实现可替换为正式解析方案。
